// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("visitor")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  chatSessions ChatSession[]
  curatorNotes CuratorNote[]
  
  @@map("users")
}

model AuthSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("auth_sessions")
}

// ============================================================================
// MUSEUM & ARTWORK DATA
// ============================================================================

model Museum {
  id          String   @id
  name        String
  description String?  @db.Text
  location    String?
  website     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  artworks         Artwork[]
  curatorNotes     CuratorNote[]
  artworkEmbeddings ArtworkEmbedding[]
  chatSessions     ChatSession[]
  messages         Message[]
  
  @@map("museums")
}

model Artwork {
  museumId  String
  id        String
  
  title       String
  artist      String
  year        Int?
  medium      String?
  dimensions  String?
  
  description String?  @db.Text
  provenance  String?  @db.Text
  
  imageUrl         String?
  gallery          String?
  accessionNumber  String?
  period           String?
  tags             String?
  
  qrCode      String?  @unique
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
  
  @@id([museumId, id])
  @@index([museumId])
  @@index([artist])
  @@index([isActive])
  @@map("artworks")
}

// ============================================================================
// CURATOR NOTES
// ============================================================================

model CuratorNote {
  id         String   @id @default(cuid())
  artworkId  String
  museumId   String
  curatorId  String
  content    String   @db.Text
  type       String   @default("interpretation")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  museum  Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
  curator User   @relation(fields: [curatorId], references: [id], onDelete: Cascade)
  
  @@index([museumId, artworkId])
  @@index([curatorId])
  @@map("curator_notes")
}

// ============================================================================
// EMBEDDINGS
// ============================================================================

model ArtworkEmbedding {
  id        String   @id @default(cuid())
  artworkId String
  museumId  String
  
  chunkType  String
  chunkIndex Int      @default(0)
  sourceId   String?
  
  content    String   @db.Text
  embedding  Unsupported("vector(1536)")
  
  tokenCount Int
  model      String   @default("text-embedding-3-small")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
  
  @@index([museumId, artworkId])
  @@index([chunkType])
  @@index([sourceId])
  @@map("artwork_embeddings")
}

// ============================================================================
// CHAT SESSIONS & MESSAGES
// ============================================================================

model ChatSession {
  id        String   @id @default(cuid())
  userId    String?
  artworkId String
  museumId  String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  museum   Museum   @relation(fields: [museumId], references: [id], onDelete: Cascade)
  messages Message[]
  
  @@index([museumId, artworkId])
  @@map("chat_sessions")
}

model Message {
  id        String   @id @default(cuid())
  sessionId String
  artworkId String
  museumId  String
  role      String
  content   String   @db.Text
  metadata  String?  @db.Text
  createdAt DateTime @default(now())
  
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  museum  Museum      @relation(fields: [museumId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([museumId, artworkId])
  @@map("messages")
}